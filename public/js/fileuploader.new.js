var qq=qq||{};qq.extend=function(a,b){for(var c in b){a[c]=b[c]}};qq.indexOf=function(a,b,c){if(a.indexOf)return a.indexOf(b,c);c=c||0;var d=a.length;if(c<0)c+=d;for(;c<d;c++){if(c in a&&a[c]===b){return c}}return-1};qq.getUniqueId=function(){var a=0;return function(){return a++}}();qq.attach=function(a,b,c){if(a.addEventListener){a.addEventListener(b,c,false)}else if(a.attachEvent){a.attachEvent("on"+b,c)}};qq.detach=function(a,b,c){if(a.removeEventListener){a.removeEventListener(b,c,false)}else if(a.attachEvent){a.detachEvent("on"+b,c)}};qq.preventDefault=function(a){if(a.preventDefault){a.preventDefault()}else{a.returnValue=false}};qq.insertBefore=function(a,b){b.parentNode.insertBefore(a,b)};qq.remove=function(a){a.parentNode.removeChild(a)};qq.contains=function(a,b){if(a==b)return true;if(a.contains){return a.contains(b)}else{return!!(b.compareDocumentPosition(a)&8)}};qq.toElement=function(){var c=document.createElement("div");return function(a){c.innerHTML=a;var b=c.firstChild;c.removeChild(b);return b}}();qq.css=function(a,b){if(b.opacity!=null){if(typeof a.style.opacity!="string"&&typeof a.filters!="undefined"){b.filter="alpha(opacity="+Math.round(100*b.opacity)+")"}}qq.extend(a.style,b)};qq.hasClass=function(a,b){var c=new RegExp("(^| )"+b+"( |$)");return c.test(a.className)};qq.addClass=function(a,b){if(!qq.hasClass(a,b)){a.className+=" "+b}};qq.removeClass=function(a,b){var c=new RegExp("(^| )"+b+"( |$)");a.className=a.className.replace(c," ").replace(/^\s+|\s+$/g,"")};qq.setText=function(a,b){a.innerText=b;a.textContent=b};qq.children=function(a){var b=[],c=a.firstChild;while(c){if(c.nodeType==1){b.push(c)}c=c.nextSibling}return b};qq.getByClass=function(a,b){if(a.querySelectorAll){return a.querySelectorAll("."+b)}var c=[];var d=a.getElementsByTagName("*");var e=d.length;for(var g=0;g<e;g++){if(qq.hasClass(d[g],b)){c.push(d[g])}}return c};qq.obj2url=function(d,e,g){var f=[],h="&",j=function(a,b){var c=e?/\[\]$/.test(e)?e:e+"["+b+"]":b;if(c!="undefined"&&b!="undefined"){f.push(typeof a==="object"?qq.obj2url(a,c,true):Object.prototype.toString.call(a)==="[object Function]"?encodeURIComponent(c)+"="+encodeURIComponent(a()):encodeURIComponent(c)+"="+encodeURIComponent(a))}};if(!g&&e){h=/\?/.test(e)?/\?$/.test(e)?"":"&":"?";f.push(e);f.push(qq.obj2url(d))}else if(Object.prototype.toString.call(d)==="[object Array]"&&typeof d!="undefined"){for(var i=0,k=d.length;i<k;++i){j(d[i],i)}}else if(typeof d!="undefined"&&d!==null&&typeof d==="object"){for(var i in d){j(d[i],i)}}else{f.push(encodeURIComponent(e)+"="+encodeURIComponent(d))}return f.join(h).replace(/^&/,"").replace(/%20/g,"+")};var qq=qq||{};qq.FileUploaderBasic=function(e){this._options={debug:false,action:"/server/upload",params:{},button:null,multiple:true,maxConnections:3,allowedExtensions:[],sizeLimit:0,minSizeLimit:0,onSubmit:function(a,b){},onProgress:function(a,b,c,d){},onComplete:function(a,b,c){},onCancel:function(a,b){},messages:{typeError:"{file} has invalid extension. Only {extensions} are allowed.",sizeError:"{file} is too large, maximum file size is {sizeLimit}.",minSizeError:"{file} is too small, minimum file size is {minSizeLimit}.",emptyError:"{file} is empty, please select files again without it.",onLeave:"The files are being uploaded, if you leave now the upload will be cancelled."},showMessage:function(a){alert(a)}};qq.extend(this._options,e);this._filesInProgress=0;this._handler=this._createUploadHandler();if(this._options.button){this._button=this._createUploadButton(this._options.button)}this._preventLeaveInProgress()};qq.FileUploaderBasic.prototype={setParams:function(a){this._options.params=a},getInProgress:function(){return this._filesInProgress},_createUploadButton:function(b){var c=this;return new qq.UploadButton({element:b,multiple:this._options.multiple&&qq.UploadHandlerXhr.isSupported(),onChange:function(a){c._onInputChange(a)}})},_createUploadHandler:function(){var e=this,g;if(qq.UploadHandlerXhr.isSupported()){g="UploadHandlerXhr"}else{g="UploadHandlerForm"}var f=new qq[g]({debug:this._options.debug,action:this._options.action,maxConnections:this._options.maxConnections,onProgress:function(a,b,c,d){e._onProgress(a,b,c,d);e._options.onProgress(a,b,c,d)},onComplete:function(a,b,c){e._onComplete(a,b,c);e._options.onComplete(a,b,c)},onCancel:function(a,b){e._onCancel(a,b);e._options.onCancel(a,b)}});return f},_preventLeaveInProgress:function(){var b=this;qq.attach(window,"beforeunload",function(a){if(!b._filesInProgress){return}var a=a||window.event;a.returnValue=b._options.messages.onLeave;return b._options.messages.onLeave})},_onSubmit:function(a,b){this._filesInProgress++},_onProgress:function(a,b,c,d){},_onComplete:function(a,b,c){this._filesInProgress--;if(c.error){this._options.showMessage(c.error)}},_onCancel:function(a,b){this._filesInProgress--},_onInputChange:function(a){if(this._handler instanceof qq.UploadHandlerXhr){this._uploadFileList(a.files)}else{if(this._validateFile(a)){this._uploadFile(a)}}this._button.reset()},_uploadFileList:function(a){for(var b=0;b<a.length;b++){if(!this._validateFile(a[b])){return}}for(var b=0;b<a.length;b++){this._uploadFile(a[b])}},_uploadFile:function(a){var b=this._handler.add(a);var c=this._handler.getName(b);if(this._options.onSubmit(b,c)!==false){this._onSubmit(b,c);this._handler.upload(b,this._options.params)}},_validateFile:function(a){var b,c;if(a.value){b=a.value.replace(/.*(\/|\\)/,"")}else{b=a.fileName!=null?a.fileName:a.name;c=a.fileSize!=null?a.fileSize:a.size}if(!this._isAllowedExtension(b)){this._error("typeError",b);return false}else if(c===0){this._error("emptyError",b);return false}else if(c&&this._options.sizeLimit&&c>this._options.sizeLimit){this._error("sizeError",b);return false}else if(c&&c<this._options.minSizeLimit){this._error("minSizeError",b);return false}return true},_error:function(c,d){function e(a,b){g=g.replace(a,b)}var g=this._options.messages[c];e("{file}",this._formatFileName(d));e("{extensions}",this._options.allowedExtensions.join(", "));e("{sizeLimit}",this._formatSize(this._options.sizeLimit));e("{minSizeLimit}",this._formatSize(this._options.minSizeLimit));this._options.showMessage(g)},_formatFileName:function(a){if(a.length>33){a=a.slice(0,19)+"..."+a.slice(-13)}return a},_isAllowedExtension:function(a){var b=-1!==a.indexOf(".")?a.replace(/.*[.]/,"").toLowerCase():"";var c=this._options.allowedExtensions;if(!c.length){return true}for(var d=0;d<c.length;d++){if(c[d].toLowerCase()==b){return true}}return false},_formatSize:function(a){var b=-1;do{a=a/1024;b++}while(a>99);return Math.max(a,.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][b]}};qq.FileUploader=function(a){qq.FileUploaderBasic.apply(this,arguments);qq.extend(this._options,{element:null,listElement:null,template:'<div class="qq-uploader"><div class="qq-upload-drop-area"><span>Drop files here to upload</span></div><div class="qq-upload-button">Upload a file</div><ul class="qq-upload-list"></ul></div>',fileTemplate:'<li><span class="qq-upload-file"></span><span class="qq-upload-spinner"></span><span class="qq-upload-size"></span><a class="qq-upload-cancel" href="#">Cancel</a><span class="qq-upload-failed-text">Failed</span></li>',classes:{button:"qq-upload-button",drop:"qq-upload-drop-area",dropActive:"qq-upload-drop-area-active",list:"qq-upload-list",file:"qq-upload-file",spinner:"qq-upload-spinner",size:"qq-upload-size",cancel:"qq-upload-cancel",success:"qq-upload-success",fail:"qq-upload-fail"}});qq.extend(this._options,a);this._element=this._options.element;this._element.innerHTML=this._options.template;this._listElement=this._options.listElement||this._find(this._element,"list");this._classes=this._options.classes;this._button=this._createUploadButton(this._find(this._element,"button"));this._bindCancelEvent();this._setupDragDrop()};qq.extend(qq.FileUploader.prototype,qq.FileUploaderBasic.prototype);qq.extend(qq.FileUploader.prototype,{_find:function(a,b){var c=qq.getByClass(a,this._options.classes[b])[0];if(!c){throw new Error("element not found "+b)}return c},_setupDragDrop:function(){var c=this,d=this._find(this._element,"drop");var e=new qq.UploadDropZone({element:d,onEnter:function(a){qq.addClass(d,c._classes.dropActive);a.stopPropagation()},onLeave:function(a){a.stopPropagation()},onLeaveNotDescendants:function(a){qq.removeClass(d,c._classes.dropActive)},onDrop:function(a){d.style.display="none";qq.removeClass(d,c._classes.dropActive);c._uploadFileList(a.dataTransfer.files)}});d.style.display="none";qq.attach(document,"dragenter",function(a){if(!e._isValidFileDrag(a))return;d.style.display="block"});qq.attach(document,"dragleave",function(a){if(!e._isValidFileDrag(a))return;var b=document.elementFromPoint(a.clientX,a.clientY);if(!b||b.nodeName=="HTML"){d.style.display="none"}})},_onSubmit:function(a,b){qq.FileUploaderBasic.prototype._onSubmit.apply(this,arguments);this._addToList(a,b)},_onProgress:function(a,b,c,d){qq.FileUploaderBasic.prototype._onProgress.apply(this,arguments);var e=this._getItemByFileId(a);var g=this._find(e,"size");g.style.display="inline";var f;if(c!=d){f=Math.round(c/d*100)+"% from "+this._formatSize(d)}else{f=this._formatSize(d)}qq.setText(g,f)},_onComplete:function(a,b,c){qq.FileUploaderBasic.prototype._onComplete.apply(this,arguments);var d=this._getItemByFileId(a);qq.remove(this._find(d,"cancel"));qq.remove(this._find(d,"spinner"));if(c.success){qq.addClass(d,this._classes.success)}else{qq.addClass(d,this._classes.fail)}},_addToList:function(a,b){var c=qq.toElement(this._options.fileTemplate);c.qqFileId=a;var d=this._find(c,"file");qq.setText(d,this._formatFileName(b));this._find(c,"size").style.display="none";this._listElement.appendChild(c)},_getItemByFileId:function(a){var b=this._listElement.firstChild;while(b){if(b.qqFileId==a)return b;b=b.nextSibling}},_bindCancelEvent:function(){var d=this,e=this._listElement;qq.attach(e,"click",function(a){a=a||window.event;var b=a.target||a.srcElement;if(qq.hasClass(b,d._classes.cancel)){qq.preventDefault(a);var c=b.parentNode;d._handler.cancel(c.qqFileId);qq.remove(c)}})}});qq.UploadDropZone=function(b){this._options={element:null,onEnter:function(a){},onLeave:function(a){},onLeaveNotDescendants:function(a){},onDrop:function(a){}};qq.extend(this._options,b);this._element=this._options.element;this._disableDropOutside();this._attachEvents()};qq.UploadDropZone.prototype={_disableDropOutside:function(b){if(!qq.UploadDropZone.dropOutsideDisabled){qq.attach(document,"dragover",function(a){if(a.dataTransfer){a.dataTransfer.dropEffect="none";a.preventDefault()}});qq.UploadDropZone.dropOutsideDisabled=true}},_attachEvents:function(){var c=this;qq.attach(c._element,"dragover",function(a){if(!c._isValidFileDrag(a))return;var b=a.dataTransfer.effectAllowed;if(b=="move"||b=="linkMove"){a.dataTransfer.dropEffect="move"}else{a.dataTransfer.dropEffect="copy"}a.stopPropagation();a.preventDefault()});qq.attach(c._element,"dragenter",function(a){if(!c._isValidFileDrag(a))return;c._options.onEnter(a)});qq.attach(c._element,"dragleave",function(a){if(!c._isValidFileDrag(a))return;c._options.onLeave(a);var b=document.elementFromPoint(a.clientX,a.clientY);if(qq.contains(this,b))return;c._options.onLeaveNotDescendants(a)});qq.attach(c._element,"drop",function(a){if(!c._isValidFileDrag(a))return;a.preventDefault();c._options.onDrop(a)})},_isValidFileDrag:function(a){var b=a.dataTransfer,c=navigator.userAgent.indexOf("AppleWebKit")>-1;return b&&b.effectAllowed!="none"&&(b.files||!c&&b.types.contains&&b.types.contains("Files"))}};qq.UploadButton=function(b){this._options={element:null,multiple:false,name:"file",onChange:function(a){},hoverClass:"qq-upload-button-hover",focusClass:"qq-upload-button-focus"};qq.extend(this._options,b);this._element=this._options.element;qq.css(this._element,{position:"relative",overflow:"hidden",direction:"ltr"});this._input=this._createInput()};qq.UploadButton.prototype={getInput:function(){return this._input},reset:function(){if(this._input.parentNode){qq.remove(this._input)}qq.removeClass(this._element,this._options.focusClass);this._input=this._createInput()},_createInput:function(){var a=document.createElement("input");if(this._options.multiple){a.setAttribute("multiple","multiple")}a.setAttribute("type","file");a.setAttribute("name",this._options.name);qq.css(a,{position:"absolute",right:0,top:0,fontFamily:"Arial",fontSize:"118px",margin:0,padding:0,cursor:"pointer",opacity:0});this._element.appendChild(a);var b=this;qq.attach(a,"change",function(){b._options.onChange(a)});qq.attach(a,"mouseover",function(){qq.addClass(b._element,b._options.hoverClass)});qq.attach(a,"mouseout",function(){qq.removeClass(b._element,b._options.hoverClass)});qq.attach(a,"focus",function(){qq.addClass(b._element,b._options.focusClass)});qq.attach(a,"blur",function(){qq.removeClass(b._element,b._options.focusClass)});if(window.attachEvent){a.setAttribute("tabIndex","-1")}return a}};qq.UploadHandlerAbstract=function(e){this._options={debug:false,action:"/upload.php",maxConnections:999,onProgress:function(a,b,c,d){},onComplete:function(a,b,c){},onCancel:function(a,b){}};qq.extend(this._options,e);this._queue=[];this._params=[]};qq.UploadHandlerAbstract.prototype={log:function(a){if(this._options.debug&&window.console)console.log("[uploader] "+a)},add:function(a){},upload:function(a,b){var c=this._queue.push(a);var d={};qq.extend(d,b);this._params[a]=d;if(c<=this._options.maxConnections){this._upload(a,this._params[a])}},cancel:function(a){this._cancel(a);this._dequeue(a)},cancelAll:function(){for(var a=0;a<this._queue.length;a++){this._cancel(this._queue[a])}this._queue=[]},getName:function(a){},getSize:function(a){},getQueue:function(){return this._queue},_upload:function(a){},_cancel:function(a){},_dequeue:function(a){var b=qq.indexOf(this._queue,a);this._queue.splice(b,1);var c=this._options.maxConnections;if(this._queue.length>=c&&b<c){var d=this._queue[c-1];this._upload(d,this._params[d])}}};qq.UploadHandlerForm=function(a){qq.UploadHandlerAbstract.apply(this,arguments);this._inputs={}};qq.extend(qq.UploadHandlerForm.prototype,qq.UploadHandlerAbstract.prototype);qq.extend(qq.UploadHandlerForm.prototype,{add:function(a){a.setAttribute("name","qqfile");var b="qq-upload-handler-iframe"+qq.getUniqueId();this._inputs[b]=a;if(a.parentNode){qq.remove(a)}return b},getName:function(a){return this._inputs[a].value.replace(/.*(\/|\\)/,"")},_cancel:function(a){this._options.onCancel(a,this.getName(a));delete this._inputs[a];var b=document.getElementById(a);if(b){b.setAttribute("src","javascript:false;");qq.remove(b)}},_upload:function(b,c){var d=this._inputs[b];if(!d){throw new Error("file with passed id was not added, or already uploaded or cancelled")}var e=this.getName(b);var g=this._createIframe(b);var f=this._createForm(g,c);f.appendChild(d);var h=this;this._attachLoadEvent(g,function(){h.log("iframe loaded");var a=h._getIframeContentJSON(g);h._options.onComplete(b,e,a);h._dequeue(b);delete h._inputs[b];setTimeout(function(){qq.remove(g)},1)});f.submit();qq.remove(f);return b},_attachLoadEvent:function(a,b){qq.attach(a,"load",function(){if(!a.parentNode){return}if(a.contentDocument&&a.contentDocument.body&&a.contentDocument.body.innerHTML=="false"){return}b()})},_getIframeContentJSON:function(a){var b=a.contentDocument?a.contentDocument:a.contentWindow.document,c;this.log("converting iframe's innerHTML to JSON");this.log("innerHTML = "+b.body.innerHTML);try{c=eval("("+b.body.innerHTML+")")}catch(err){c={}}return c},_createIframe:function(a){var b=qq.toElement('<iframe src="javascript:false;" name="'+a+'" />');b.setAttribute("id",a);b.style.display="none";document.body.appendChild(b);return b},_createForm:function(a,b){var c=qq.toElement('<form method="post" enctype="multipart/form-data"></form>');var d=qq.obj2url(b,this._options.action);c.setAttribute("action",d);c.setAttribute("target",a.name);c.style.display="none";document.body.appendChild(c);return c}});qq.UploadHandlerXhr=function(a){qq.UploadHandlerAbstract.apply(this,arguments);this._files=[];this._xhrs=[];this._loaded=[]};qq.UploadHandlerXhr.isSupported=function(){var a=document.createElement("input");a.type="file";return"multiple"in a&&typeof File!="undefined"&&typeof(new XMLHttpRequest).upload!="undefined"};qq.extend(qq.UploadHandlerXhr.prototype,qq.UploadHandlerAbstract.prototype);qq.extend(qq.UploadHandlerXhr.prototype,{add:function(a){if(!(a instanceof File)){throw new Error("Passed obj in not a File (in qq.UploadHandlerXhr)")}return this._files.push(a)-1},getName:function(a){var b=this._files[a];return b.fileName!=null?b.fileName:b.name},getSize:function(a){var b=this._files[a];return b.fileSize!=null?b.fileSize:b.size},getLoaded:function(a){return this._loaded[a]||0},_upload:function(b,c){var d=this._files[b],e=this.getName(b),g=this.getSize(b);this._loaded[b]=0;var f=this._xhrs[b]=new XMLHttpRequest;var h=this;f.upload.onprogress=function(a){if(a.lengthComputable){h._loaded[b]=a.loaded;h._options.onProgress(b,e,a.loaded,a.total)}};f.onreadystatechange=function(){if(f.readyState==4){h._onComplete(b,f)}};c=c||{};c["qqfile"]=e;var j=qq.obj2url(c,this._options.action);f.open("POST",j,true);f.setRequestHeader("X-Requested-With","XMLHttpRequest");f.setRequestHeader("X-File-Name",encodeURIComponent(e));f.setRequestHeader("Content-Type","application/octet-stream");f.send(d)},_onComplete:function(a,b){if(!this._files[a])return;var c=this.getName(a);var d=this.getSize(a);this._options.onProgress(a,c,d,d);if(b.status==200){this.log("xhr - server response received");this.log("responseText = "+b.responseText);var e;try{e=eval("("+b.responseText+")")}catch(err){e={}}this._options.onComplete(a,c,e)}else{this._options.onComplete(a,c,{})}this._files[a]=null;this._xhrs[a]=null;this._dequeue(a)},_cancel:function(a){this._options.onCancel(a,this.getName(a));this._files[a]=null;if(this._xhrs[a]){this._xhrs[a].abort();this._xhrs[a]=null}}})
